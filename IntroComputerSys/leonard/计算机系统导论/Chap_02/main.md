# 整数

## 整数表示

### 无符号整数 uint

C 中支持无符号整型数. 其被表示为2进制数码的位级数字序列. 如

```C
0 == 0b0000
15 == 0b1111
```

对于 `word length` 为 $w$ 的二进制数字表示 $\{b_i\}_{i=0}^{w-1}$, 其值为(0位为最低位)

$$
\textrm{Value}(\{b_i\}) = \sum_{i=0}^{w-1} b_i 2^i.
$$

其值范围

$$
0 \leq \textrm{Value}(\{b_i\}) \leq 2^{w} - 1
$$

### 有符号整数

C 中的有符号整型 `int` 通过置其最高位作为符号位实现 (complement encoding). 事实上有符号数的值为

$$
\textrm{Value}(\{b_i\}) = - 2^{w-1} b_{w-1} + \sum_{i=0}^{w-2} b_i 2^i.
$$

如(设 $w = 4$)

```C
-8 == 0b1000
-1 == 0b1111
0 == 0b0000
7 == 0b0111
```

可以证明表示范围:

$$
-2^{w-1} \leq \textrm{Value}_w \leq 2^{w-1} -1
$$

## 整数计算

### 加法

-   对于无符号整数, 其加法:

    $$
    V(b^1) + V(b^2) = \sum_{i=0}^{w-1} (b_i^1 + b_i^2) 2 ^i.
    $$

    其计算上只需要从低位到高位执行位级加法, 并在需要时进位. 有时两个 `w` 长的整数的数学和可能长为 `w+1`, 在 `C` 中, 溢出的高位被舍去. 从而无符号整数的加法事实上实现了数学的模最大值加法:

    $$
    \textrm{uint}(x) + \textrm{uint}(y) \rightarrow \textrm{uint}(x+y \mod 2^w)
    $$
-   对于有符号整数, 其加法:

    $$
    V(b^1) + V(b^2) = -2^{w-1} (b^1_{w-1} + b^2_{w-1}) + \sum_{i=0}^{w-2} (b_i^1 + b_i^2) 2 ^i.
    $$

    我们证明无符号整数的位级加法(逢2进1, 溢出舍去高位)同样在有符号整数这里给出正确的结果. 在 $0\sim w-2$的位上这种算法是正确的, 我们只需要关注符号位, 考虑进位与否为 $s$, 代表$0\sim w-2$表示的无符号二进制整数 (事实上正是其值加上偏置 $x + 2^{w-1} x_{w-1}$)之和是否超过 $2^{w-1}$, 即

    $$
    \begin{aligned}
    V(b^1) +_{uint} V(b^2) &= -2^{w-1} (b^1_{w-1} + b^2_{w-1} + s) + \Big(V(b^1) + b_{w-1}^1 2^{w-1} +V(b^2) + b_{w-1}^2 2^{w-1} \mod 2^{w-1}\Big) \\
    &= -2^{w-1} (b^1_{w-1} + b^2_{w-1} + s\mod 2) + \Big(V(b^1) + b_{w-1}^1 2^{w-1} +V(b^2) + b_{w-1}^2 2^{w-1} - s 2^{w-1}\Big) \\
    &= V(b^1) + V(b^2) - \eta 2^{w} \Big|_{\textrm{omit } > w-1 \textrm{ bits}} \\
    &= V(b^1) + V(b^2)
    \end{aligned} 
    $$

    从而可以看到无符号整数使用同样的算法: 逢2进1, 溢出舍去高位确实可以给出正确的和. 但溢出问题仍然存在, 其发生在我们需要将 $V(b^1) + V(b^2)$ 的最高位解释位符号位. 换言之, 如果 $V(b^1) + V(b^2)$ 的值在 `int` 的表示范围内, 那么 `+_{uint}` 总会返回正确的结果. 否则会出现溢出错误(C编译器并不会提示错误). 溢出规则为

    1.  如果 $x + y \geq 2^{w-1}$ : 

        $$
        \textrm{int}(x) + \textrm{int}(y) = \textrm{int} (x + y -2^w)
        $$
    
    2.  如果 $x + y < - 2^{w-1}$ : 

        $$
        \textrm{int}(x) + \textrm{int}(y) = \textrm{int} (x + y +2^w)
        $$



